name: deploy

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Update DNS settings
      run: |
        echo "nameserver 1.1.1.1" | sudo tee /etc/resolv.conf > /dev/null
        echo "nameserver 8.8.8.8" | sudo tee -a /etc/resolv.conf > /dev/null
        cat /etc/resolv.conf

    - name: Check DNS resolution
      run: |
        host ${{ secrets.NCP_HOST }}
        nslookup ${{ secrets.NCP_HOST }}

    - name: Wait for DNS propagation
      run: sleep 30

    - name: Check network connectivity
      run: |
        ping -c 4 ${{ secrets.NCP_HOST }}

    - name: NCP login and after git pull, docker compose up --build
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.NCP_HOST }}
        username: ${{ secrets.NCP_USERNAME }}
        password: ${{ secrets.NCP_PASSWORD }}
        port: ${{ secrets.NCP_PORT }}
        script_stop: true
        debug: true
        script: |
          cd /root/pdf_chatbot
          ^C
          git pull origin main
          uvicorn main:app --reload

    - name: Check SSH connection
      if: failure()
      run: |
        nc -zv ${{ secrets.NCP_HOST }} ${{ secrets.NCP_PORT }}